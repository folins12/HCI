<style>
  .btn-addmyplant {
    display: inline-block;
    background-color: #134509;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 1.2em;
    margin-top: 10px;
    cursor: pointer;
  }
  
  .btn-addmyplant p {
    color: white;
  }
  
  .btn-addmyplant:hover {
    background-color: #0a3b00;
    transform: scale(1.05);
    transition: 0.2s;
  }
</style>

<div class="plants-container">
  <p class="plant-title">PlantExplorer</p>
  <p class="intro-text">Esplora e conosci le caratteristiche di queste piante e divertiti a selezionare i filtri per scoprire le piante che si addicono ai tuoi gusti.</p>

  <%= form_with url: infoplants_path, method: :get, local: true, class: "search-form" do |form| %>
    <div class="search-bar-container">
      <%= text_field_tag :query, params[:query], placeholder: 'Cerca...', class: "search-bar" %>
      <%= form.submit "Cerca", class: "search-button" %>
    </div>
  <% end %>

  <%= form_with url: infoplants_path, method: :get, local: true, class: "filters-form", id: "filters-form" do |form| %>
    <div class="filters-container">
      <div class="filter">
        <%= label_tag :typology, 'Tipologia' %>
        <%= select_tag :typology, options_for_select(Plant.pluck(:typology).uniq, params[:typology]), include_blank: true %>
      </div>
      <div class="filter">
        <%= label_tag :climate, 'Clima' %>
        <%= select_tag :climate, options_for_select(Plant.pluck(:climate).uniq, params[:climate]), include_blank: true %>
      </div>
      <div class="filter">
        <%= label_tag :use, 'Uso' %>
        <%= select_tag :use, options_for_select(Plant.pluck(:use).uniq, params[:use]), include_blank: true %>
      </div>
      <div class="filter">
        <%= label_tag :light, "Luce" %>
        <%= select_tag :light, options_for_select([['ombra completa', 1], ['ombra parziale', 2], ['luce indiretta', 3], ['sole diretto', 4]], params[:light]), include_blank: true %>
      </div>
      <div class="filter">
        <%= label_tag :size, "Dimensione" %>
        <%= select_tag :size, options_for_select([['piccola', 1], ['media', 2], ['grande', 3]], params[:size]), include_blank: true %>
      </div>
      <div class="filter">
        <%= label_tag :irrigation, "Irrigazione" %>
        <%= select_tag :irrigation, options_for_select([['raramente', 1], ['ogni tanto', 2], ['frequentemente', 3]], params[:irrigation]), include_blank: true %>
      </div>
      <div class="apply-filters">
        <%= form.submit "Applica", class: "apply-button" %>
      </div>
      <div class="clear-filters">
        <%= button_tag "Cancella", type: 'button', class: "clear-button", onclick: "clearFilters()" %>
      </div>
    </div>
  <% end %>
</div>

<div class="plants-grid">
  <% if @plants.any? %>
    <% @plants.each do |plant| %>
      <div class="plant-box">
        <div class="plant-image">
          <%= image_tag "#{plant.name}.jpg", alt: plant.name %>
        </div>
        
        <div class="plant-info">
          <p class="nome"><strong><%= plant.name %></strong></p>
          <p><strong>Tipologia:</strong> <%= plant.typology %></p>
          <p><strong>Luce:</strong> <%= ['ombra completa', 'ombra parziale', 'luce indiretta', 'sole diretto'][plant.light - 1] %></p>
          <p><strong>Irrigazione:</strong> <%= ['raramente', 'ogni tanto', 'frequentemente'][plant.irrigation - 1] %></p>
          <p><strong>Dimensione:</strong> <%= ['piccola', 'media', 'grande'][plant.size - 1] %></p>
          <p><strong>Clima:</strong> <%= plant.climate %></p>
          <p><strong>Uso:</strong> <%= plant.use %></p>
          <p><strong>Descrizione:</strong> <%= plant.description %></p>

          <% if current_user %>
            <% if @user_plants.exclude?(plant.id) %>
              <div class="btn-addmyplant" data-myplant-id="<%= plant.id %>">
                <p>AGGIUNGI ALLE MIE PIANTE</p>
              </div>
            <% else %>
              <p>Questa pianta è già nelle tue piante.</p>
            <% end %>
          <% end %>
          
        </div>
      </div>
    <% end %>
  <% else %>
    <p class="no-results">Non ci sono piante con questi filtri</p>
  <% end %>
</div>

<% if params[:query].present? || params[:typology].present? || params[:climate].present? || params[:use].present? || params[:light].present? || params[:size].present? || params[:irrigation].present? %>
  <div class="back-button-container">
    <%= link_to 'Torna indietro', infoplants_path, class: 'back-button' %>
  </div>
<% end %>

<script>
  function clearFilters() {
    const form = document.getElementById("filters-form");
    const selects = form.querySelectorAll("select");
    
    selects.forEach(select => {
      select.selectedIndex = 0; // Reset each select to its default option
    });
  }


  document.addEventListener("DOMContentLoaded", function() {
      const reserveButtons = document.querySelectorAll(".btn-addmyplant");
      
      reserveButtons.forEach(button => {
          button.addEventListener("click", function() {
              const myplantId = this.dataset.myplantId;
              // Disabilita il bottone per evitare clic ripetuti
              this.style.pointerEvents = "none";

              fetch('/addmyplant', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                  },
                  body: JSON.stringify({ myplant_id: myplantId }) // Modifica questo campo se necessario
              })
              .then(response => {
                  if (!response.ok) {
                      return response.text().then(text => {
                          throw new Error(text);
                      });
                  }
                  return response.json();
              })
              .then(data => {
                  if (data.success) {
                      this.querySelector('p').textContent = "Pianta aggiunta con successo!";
                  } else {
                      alert(data.message || "Errore nella aggiunta. Riprova.");
                  }
              })
              .catch(error => {
                  console.error('Errore:', error);
                  alert('Errore: ' + error.message);
              })
              .finally(() => {
                  // Riabilita il bottone in caso di errore o successo
                  this.style.pointerEvents = "auto"; // Riabilita i clic
              });
          });
      });
  });


    
</script>
